<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset="utf-8" />
  <meta content="width=device-width, initial-scale=1" name="viewport" />
  <link rel="stylesheet" href="style.css" />
  <link rel="icon" type="image/png" href="img/faci.png">
  <title>COWEB - Central Operacional Web</title>
</head>

<body>

  <header style="position:relative; width:100%; height:180px;">
    <!-- Banner institucional de fundo -->
    <img alt="Centro de Opera√ß√µes - Prefeitura do Rio" src="img/banner-institucional.jpg"
      style="width:100%; height:180px; object-fit:cover; border-radius:0; position:absolute; left:0; top:0; z-index:1;">

    <!-- Seletor de est√°gio flutuando -->
    <div class="seletor-estagio" style="position:absolute; top:0px; left:0px; z-index:10;">
      <div id="estagioBanner" style="cursor:pointer; position:relative; width:320px; height:179px;">
        <img id="estagioImgBanner" src="estagios/estagio1.jpg" alt="Est√°gio Atual"
          style="width:100%; height:100%; object-fit:cover; border-radius:14px; box-shadow:0 2px 12px #0005;">
        <div id="menuEstagios"
          style="display:none; position:absolute; top:auto; left:0; width:320px; background:#222e; border-radius:0 0 14px 14px; z-index:100;">
          <!-- Itens criados pelo JS -->
          <button id="btnAbrirVisualizador"
            style="width:90%;margin:14px 5%;background:#2979ff;color:#fff;font-size:1.05em;border:none;padding:10px;border-radius:7px;cursor:pointer;">
            Abrir em tela cheia
          </button>
        </div>
      </div>
    </div>

    <!-- Painel direito ou outros elementos do header -->
    <div class="right-image-panel" style="position:absolute; right:14px; top:14px; height:110px; width:210px;">
      <img alt="Banner institucional" id="clicavelImage" src="nils-calor/1.jpg"
        style="width:100%; height:100%; object-fit:cover; border-radius:12px;" />
    </div>

    <div class=" seletor-calor" style="position:absolute; top:0px; right:0px; z-index:10;">
      <div id="calorBanner" style="cursor:pointer; position:relative; width:320px; height:179px;">
        <img id="calorImgBanner" src="nils-calor/calor1.jpg" alt="Calor Atual"
          style="width:100%; height:100%; object-fit:cover; border-radius:14px; box-shadow:0 2px 12px #0005;">
        <div id="menuCalor"
          style="display:none; position:absolute; top:auto; left:0; width:320px; background:#222e; border-radius:14px 14px 14px 14px; z-index:100;">
          <!-- Itens criados pelo JS -->
          <button id="btnAbrirVisualizadorCalor"
            style="width:90%;margin:14px 5%;background:#2979ff;color:#fff;font-size:1.05em;border:none;padding:10px;border-radius:7px;cursor:pointer;">
            Abrir em tela cheia
          </button>
        </div>
      </div>
    </div>

  </header>

  <div class="top-buttons">
    <button class="action-button" id="btnSites">Gerenciar Sistemas</button>
    <button class="action-button" id="btnAnyDesk">Conex√µes AnyDesk</button>
    <button class="action-button" id="btnAcessosRemotos">Infraestrutura Remota</button>
    <button id="btn-var-legal" class="top-btn">Painel de Acesso R√°pido</button>

    <!-- Bot√£o para abrir o modal (s√≥ aparece no mobile) -->
    <button id="btnAbrirModalSeletores" class="btn-modal-seletores" title="Selecionar Est√°gio / Calor">
      Selecionar Est√°gio / Calor
    </button>


  </div>

  <!-- Painel √∫nico de Top Acessos Gerais -->
  <div id="top-geral-float" class="top-geral-panel">
    <h2>üèÜ Top Acessos Gerais</h2>
    <ul id="lista-top-geral"></ul>
  </div>

  <!-- √Årea Sites -->
  <main id="mainSites">
    <div class="left-column">
      <h2>üìã Registro de Sistemas Web</h2>

      <div class="status-bar">
        <span class="online">Online: <span id="onlineCount">0</span></span>
        <span class="offline">Offline: <span id="offlineCount">0</span></span>
      </div>

      <div class="input-area">
        <input placeholder="Nome do sistema" type="text" />
        <input placeholder="URL do sistema" type="text" />
        <input placeholder="Usu√°rio de acesso" type="text" />
        <input placeholder="Senha de acesso" type="password" />
        <input placeholder="Contato respons√°vel" type="text" />

        <button class="test-button">Testar Conex√£o</button>
        <button class="clear-button" id="btnLimparSites">Limpar Todos</button>
        <button class="export-button">Exportar .TXT</button>

        <div class="export-status-container">
          <div class="export-status-row">
            <div class="export-status-label-group">
              <span class="export-status-label">Exportar Ativos</span>
              <span class="export-status-count" id="onlineExportCount">(0)</span>
            </div>
            <button class="export-status-button" id="exportOnlineBtn">Exportar</button>
          </div>

          <div class="export-status-row">
            <div class="export-status-label-group">
              <span class="export-status-label">Exportar Inativos</span>
              <span class="export-status-count" id="offlineExportCount">(0)</span>
            </div>
            <button class="export-status-button" id="exportOfflineBtn">Exportar</button>
          </div>
        </div>
      </div>
    </div>

    <div class="right-column">
      <h2>üóÇÔ∏è Sistemas Registrados</h2>
      <input id="searchInput" placeholder="Buscar sistema pelo nome..." type="text" />

      <div style="margin:10px 0; display:flex; gap:10px; align-items:center;">
        <button class="reload-all-button" id="reloadAllBtn">Revalidar Todos</button>
        <button class="filter-status-button active" id="filterAllBtn">Todos</button>
        <button class="filter-status-button" id="filterOnlineBtn">Online</button>
        <button class="filter-status-button" id="filterOfflineBtn">Off line</button>
      </div>

      <div class="site-list" id="site-list"></div>
    </div>

  </main>

  <!-- Modal de edi√ß√£o (sites) -->
  <div class="modal" id="editModal">
    <div class="modal-content">
      <h3>Editar Registro</h3>
      <input id="editNome" placeholder="Nome do sistema" type="text" />
      <input id="editLogin" placeholder="Usu√°rio de acesso" type="text" />
      <input id="editSenha" placeholder="Senha de acesso" type="text" />
      <input id="editContato" placeholder="Contato respons√°vel" type="text" />

      <div class="modal-buttons">
        <button id="btnSalvarEdicao">Salvar Altera√ß√µes</button>
        <button id="btnCancelarEdicao">Cancelar</button>
      </div>
    </div>
  </div>

  <!-- Modal Painel de Acesso R√°pido -->
  <div id="modal-overlay" class="hidden">
    <div id="modal-var-legal">
      <div class="modal-header">
        <h2>Painel de Acesso R√°pido</h2>
        <button id="modal-close" title="Fechar painel de acesso r√°pido">&times;</button>
      </div>
      <div class="modal-body">
        <input class="search-input" type="text" placeholder="Buscar...">
        <div class="panel-list">
          <!-- Linha 1 -->
          <a href="http://10.50.30.161/agenda-web/public/" class="panel-item" target="_blank" rel="noopener noreferrer">
            <img src="img/Agenda.png" alt="Agenda" />

          </a>
          <a href="http://10.50.30.160/titulos/wp-login.php?redirect_to=http%3A%2F%2F10.50.30.160%2Ftitulos%2Fwp-admin%2F&reauth=1"
            class="panel-item" target="_blank" rel="noopener noreferrer">
            <img src="img/intranet.png" alt="Intranet" />

          </a>
          <a href="https://10.50.30.161/listaPresenca/" class="panel-item" target="_blank" rel="noopener noreferrer">
            <img src="img/ListsPresent.png" alt="Lista de Presen√ßa" />

          </a>

          <a href="https://cor.multiviscloud.com/index.html" class="panel-item" target="_blank"
            rel="noopener noreferrer">
            <img src="img/Multivis.png" alt="Multivis" />
            <span></span>
          </a>

          <a href="http://10.50.30.160/intrati/tutoriais/padronizacao-de-computadores/" class="panel-item" target="_blank"
            rel="noopener noreferrer">
            <img src="img/padroniza√ß√£o de computadores.png" alt="Multivis" />
            <span></span>
          </a>

        </div>
      </div>
    </div>
  </div>

  <!-- √Årea AnyDesk -->
  <main id="mainAnyDesk" style="display:none;">
    <div class="left-column">
      <h2>üíª Cadastro de Conex√µes AnyDesk</h2>

      <div class="input-area">
        <input id="nomeAny" placeholder="Nome do terminal" type="text" />
        <input id="ipAny" placeholder="Endere√ßo ou ID AnyDesk" type="text" />
        <input id="loginAny" placeholder="MCOR" type="text" />
        <input id="senhaAny" placeholder="Senha" type="password" />
        <button class="test-button" id="btnCadastrarAny">Cadastrar</button>
        <button class="clear-button" id="btnLimparAny">Limpar</button>
      </div>
    </div>

    <div class="right-column">
      <h2>üìã Conex√µes Registradas</h2>

      <!-- Barra de pesquisa AnyDesk -->
      <input id="searchAnyDeskInput" placeholder="üîç Buscar conex√£o..." type="text" />

      <!-- Modal de Edi√ß√£o AnyDesk -->
      <div id="editAnyModal" class="modal" style="display:none;">
        <div class="modal-content">
          <h3>Editar Conex√£o AnyDesk</h3>
          <input type="text" id="editAnyNome" placeholder="Nome do terminal" />
          <input type="text" id="editAnyIP" placeholder="Endere√ßo ou ID AnyDesk" />
          <input type="text" id="editAnyUser" placeholder="MCOR" />
          <input type="password" id="editAnySenha" placeholder="Senha" />
          <div class="modal-buttons">
            <button id="btnSalvarAnyEdit">Salvar</button>
            <button id="btnCancelarAnyEdit">Cancelar</button>
          </div>
        </div>
      </div>
      <div class="site-list" id="anydesk-list"></div>
    </div>

  </main>

  <!-- √Årea Acessos Remotos -->
  <main id="mainAcessosRemotos" style="display:none;">
    <div class="left-column">
      <h2>üñ•Ô∏è Registro de Infraestrutura Remota-Cameras</h2>

      <div class="input-area">
        <input id="inputSetor" placeholder="Departamento/Setor" type="text" />
        <input id="inputAndar" placeholder="Andar" type="text" />
        <input id="inputTipo" placeholder="Tipo de Equipamento" type="text" />
        <input id="inputCamera" placeholder="C√¢mera" type="text" />
        <input id="inputSala" placeholder="Sala T√©cnica" type="text" />
        <input id="inputIP" placeholder="Endere√ßo IP" type="text" />
        <button class="test-button" id="btnCadastrarAcesso">Cadastrar</button>
        <button class="export-button" id="btnExportarAcessos">Exportar .TXT</button>
        <!-- <button id="btnImportarEquipamentos">Importar Equipamentos (JSON)</button> -->

        <button class="clear-button" id="btnLimparAcesso">Limpar</button>
      </div>
    </div>

    <div class="right-column">
      <h2>üìã Equipamentos Registrados</h2>
      <!-- Barra de pesquisa igual a Sistemas Registrados -->
      <div class="status-bar" style="margin-bottom:12px;">
        <span class="online">Ativos: <span id="remoteOnlineCount">0</span></span>
        <span class="offline">Inativos: <span id="remoteOfflineCount">0</span></span>
      </div>

      <div style="margin-bottom:12px;">
        <input id="searchRemoteInput" class="search-input" placeholder="üîç Buscar equipamento..." type="text" />
      </div>

      <!-- Bot√µes de filtro iguais aos de Sistemas Registrados -->
      <div style="margin-bottom:12px;">
        <button id="btnVerificarRemotos" class="action-button" style="margin-bottom:12px;">
          Verificar Todas
        </button>
        <button id="filterRemoteAll" class="filter-status-button active">Todos</button>
        <button id="filterRemoteCFTV" class="filter-status-button">CFTV</button>
        <button id="filterRemoteContAcesso" class="filter-status-button">Cont.Acesso</button>
      </div>

      <!-- Lista filtrada -->
      <div id="acessos-remotos-list" class="site-list"></div>

    </div>

  </main>

  <!-- Modal de Detalhes de Equipamento -->
  <div id="modalDetalhesEquipamento" class="modal" style="display: none;">
    <div class="modal-content">
      <h3>Detalhes do Equipamento</h3>
      <p id="detalhesTexto"></p>
      <button id="btnCopiarDetalhes" class="test-button">üìã Copiar Dados</button>
      <button id="btnFecharDetalhes" class="clear-button">Fechar</button>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js";
    import { Timestamp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-firestore.js";
    import { format } from "https://cdn.jsdelivr.net/npm/date-fns@3.6.0/+esm";
    import {
      getFirestore, doc, getDoc, setDoc, updateDoc, increment,
      collection, getDocs, query, orderBy, limit,
      addDoc, deleteDoc, onSnapshot             // <- ADICIONE ISTO
    } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCpnDf40JQ3COptyNJFZnqj9niTn5iBDeY",
      authDomain: "coldgend.firebaseapp.com",
      projectId: "coldgend",
      storageBucket: "coldgend.firebasestorage.app",
      messagingSenderId: "82052509807",
      appId: "1:82052509807:web:c03348372ed390ba101d9a",
      measurementId: "G-7CN6FW8GDX"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const sitesCollection = collection(db, "sites");
    const anydeskCollection = collection(db, "anydesk");
    const acessosRemotosCollection = collection(db, "acessos_remotos")

    // --- Camera Capture ---
    /*   const video   = document.getElementById('video');
      const canvas  = document.getElementById('canvas');
      const btnStart = document.getElementById('btnStartCam');
      const btnSnap  = document.getElementById('btnSnap'); */

    /* Parte de Nivels de Calor */
    const estagioImgBanner = document.getElementById("estagioImgBanner");
    const estagioBanner = document.getElementById("estagioBanner");
    const menuEstagios = document.getElementById("menuEstagios");
    const btnAbrirVisualizador = document.getElementById("btnAbrirVisualizador");

    /* Parte de Estagio */
    const calorImgBanner = document.getElementById("calorImgBanner");
    const calorBanner = document.getElementById("calorBanner");
    const menuCalor = document.getElementById("menuCalor");
    const btnAbrirVisualizadorCalor = document.getElementById("btnAbrirVisualizadorCalor");

    // Bot√µes de abertura dos menus
    const btnSeletores = document.getElementById("btnAbrirModalSeletores");
    const bannerEstagio = document.getElementById("estagioBanner");
    const bannerCalor = document.getElementById("calorBanner");
    let stream;

    // Seletor de est√°gio
    const totalEstagios = 5;
    const pastaEstagios = "estagios";
    const extensao = ".jpg";
    let estagioAtual = 1;
    
    // URL da API de est√°gio externa (sincroniza√ß√£o autom√°tica)
    const API_ESTAGIO_URL = "https://aplicativo.cocr.com.br/estagio_api_app";

    // Seletor de Niveis de Calor
    const totalCalor = 5;
    const pastaCalor = "nils-calor";
    const extCalor = ".jpg";
    let calorAtual = 1;

    /* Seletor do Gerenciar Sistemas Web */
    let sites = [];
    let filtroTipo = "todos";
    let filtroStatus = 'todos';

    /* Seletor do Anydesk */
    let carregaAnyDesk = [];
    let filtroAtual = '';
    let editAnyIndex = null;
    let filtroAnyDesk = "";

    /* Seletor do infraestrutura remota */
    let filtroTipoRemoto = "todos";
    let equipamentosCFTV = [];
    let acessosRemotos = [];
    let filtroRemoto = "";
    let equipamentosControleAcesso = [];

    let editIndex = null;



    // REGISTRA ACESSO GLOBAL NO FIRESTORE
    export function registrarAcessoGeralGlobal(id, nome, tipo, link = "") {
      if (!id || !nome || !tipo) return;

      const docRef = doc(db, "ranking_acessos", id);
      getDoc(docRef).then((docSnap) => {
        if (docSnap.exists()) {
          updateDoc(docRef, {
            acessos: increment(1),
            ultimoAcesso: Timestamp.now()
          });
        } else {
          setDoc(docRef, {
            id,
            nome,
            tipo,
            acessos: 1,
            img: `img/${nome}.png`,
            link: link && !link.startsWith("img/") ? link : gerarLinkPadrao(id, tipo),
            ultimoAcesso: Timestamp.now()
          });
        }
      });
    }

    /* Fun√ß√£o para gerar um link automaticamente */
    function gerarLinkPadrao(id, tipo) {
      const acessosFixos = {
        agenda: "https://agenda.seusite.com",
        intranet: "https://intranet.seusite.com",
        eventos: "https://powerbi.seusite.com/eventos",
        backup: "anydesk:123456789", // exemplo de ID AnyDesk
        relatorio: "https://sistemas.seusite.com/relatorio"
        // adicione mais conforme necess√°rio
      };

      // tenta encontrar pelo ID
      if (acessosFixos[id]) {
        return acessosFixos[id];
      }

      // fallback por tipo
      if (tipo === "anydesk") return id;
      if (tipo === "painel") return `https://painel.seusite.com/${id}`;
      if (tipo === "sistema") return `https://sistemas.seusite.com/${id}`;

      return "";
    }

    export function iniciarRankingTempoReal() {
      const q = query(collection(db, "ranking_acessos"), orderBy("acessos", "desc"), limit(10));
      const ul = document.getElementById("lista-top-geral");
      if (!ul) return;

      onSnapshot(q, (querySnapshot) => {
        ul.innerHTML = "";
        querySnapshot.forEach(doc => {
          const item = doc.data();
          let icon = "√¢≈ì¬®";

          if (item.tipo === "painel" && item.img) {
            icon = `<img src="${item.img}" style="width:32px; height:32px; object-fit:cover; border-radius:5px; margin-right:7px;">`;
          } else if (item.tipo === "sistema") icon = "üåê";
          else if (item.tipo === "anydesk") icon = "üíª";
          else if (item.tipo === "infra") icon = "üîí";

          // Formatando data
          let dataFormatada = "";
          if (item.ultimoAcesso?.seconds) {
            const data = new Date(item.ultimoAcesso.seconds * 1000);
            const local = data.toLocaleString("pt-BR", {
              day: "2-digit",
              month: "2-digit",
              year: "numeric",
              hour: "2-digit",
              minute: "2-digit"
            });
            dataFormatada = `<br><small style="color:#aaa;">√öltimo: ${local}</small>`;
          }

          const li = document.createElement("li");
          li.innerHTML = `
        ${icon} <b>${item.nome}</b> <small>${item.tipo}</small>
        <span>(${item.acessos})</span>
        ${dataFormatada}
      `;

          let urlFinal = item.link?.trim();

          // Se n√£o tem link, tenta gerar com base no tipo e id:
          if (!urlFinal) {
            urlFinal = gerarLinkPadrao(item.id, item.tipo);
          }

          if (urlFinal) {
            const btn = document.createElement("button");
            btn.textContent = "Ir";
            btn.className = "btn-acessar";
            btn.style.marginLeft = "10px";
            btn.addEventListener("click", () => {
              if (item.tipo === "anydesk") {
                window.location.href = `anydesk:${urlFinal}`;
              } else {
                window.open(urlFinal, "_blank");
              }
            });
            li.appendChild(btn);
          }

          ul.appendChild(li);
        });
      });
    }

    document.querySelectorAll('.panel-item').forEach(item => {
      item.addEventListener('click', function () {
        const nome = item.querySelector('img')?.alt?.trim() || 'Acesso R√°pido';
        const id = nome.toLowerCase().replace(/\s+/g, '_');
        const tipo = "painel";
        const link = item.getAttribute("href"); // √¢≈ì‚Ä¶ correto

        registrarAcessoGeralGlobal(id, nome, tipo, link);
      });
    });



    // Cria itens do menu de est√°gios - link que abre em outro navegador
    for (let i = 1; i <= totalEstagios; i++) {
      const item = document.createElement('div');
      item.className = 'estagio-item' + (i === estagioAtual ? ' selected' : '');
      const mini = document.createElement('img');
      mini.src = `${pastaEstagios}/estagio${i}${extensao}`;
      mini.alt = `Miniatura Est√°gio ${i}`;
      const label = document.createElement('span');
      label.textContent = `Est√°gio ${i}`;
      item.appendChild(mini);
      item.appendChild(label);

      item.dataset.estagio = i;
      item.addEventListener('click', function (e) {
        estagioAtual = Number(this.dataset.estagio);
        estagioImgBanner.src = `${pastaEstagios}/estagio${estagioAtual}${extensao}`;
        menuEstagios.querySelectorAll('.estagio-item').forEach(el => el.classList.remove('selected'));
        this.classList.add('selected');
        menuEstagios.style.display = 'none';
        atualizarEstagioFirebase(estagioAtual); // Fun√ß√£o do Firestore (j√° existente no seu projeto)
        e.stopPropagation();
      });
      menuEstagios.insertBefore(item, btnAbrirVisualizador);
    }

    // Cria itens do menu de calor
    for (let i = 1; i <= totalCalor; i++) {

      const item = document.createElement('div');
      item.className = 'calor-item' + (i === calorAtual ? ' selected' : '');
      const mini = document.createElement('img');
      mini.src = `${pastaCalor}/calor${i}${extCalor}`;
      mini.alt = `Miniatura Calor ${i}`;
      const label = document.createElement('span');
      label.textContent = `Calor ${i}`;
      item.appendChild(mini);
      item.appendChild(label);

      item.dataset.calor = i;
      item.addEventListener('click', function (e) {
        calorAtual = Number(this.dataset.calor);
        calorImgBanner.src = `${pastaCalor}/calor${calorAtual}${extCalor}`;
        menuCalor.querySelectorAll('.calor-item').forEach(el => el.classList.remove('selected'));
        this.classList.add('selected');
        menuCalor.style.display = 'none';
        atualizarCalorFirebase(calorAtual);
        e.stopPropagation();
      });
      menuCalor.insertBefore(item, btnAbrirVisualizadorCalor);
    }

    buscarEstagioInicial();
    buscarCalorInicial();

    function acessarRanking(tipo, link) {
      if (!link) return;

      if (tipo === "anydesk") {
        window.location.href = `anydesk:${link}`;
      } else {
        window.open(link, "_blank");
      }
    }

    function updateContadoresRemotos() {
      const total = acessosRemotos.length;
      const ativos = acessosRemotos.filter(item => item.status === "ativa").length;
      const inativos = total - ativos;
      document.getElementById("remoteOnlineCount").textContent = ativos;
      document.getElementById("remoteOfflineCount").textContent = inativos;
    }

    function renderizarSites() {
      const siteList = document.getElementById("site-list");
      if (!siteList) {
        console.warn('Elemento #site-list n√£o encontrado no DOM!');
        return; // Sai da fun√ß√£o se n√£o existe, assim evita qualquer erro.
      }
      siteList.innerHTML = "";

      let sitesFiltrados = sites.filter(site => site.nome.toLowerCase().includes(filtroAtual.toLowerCase()));

      if (filtroStatus === 'online') {
        sitesFiltrados = sitesFiltrados.filter(site => site.status === 'online');
      } else if (filtroStatus === 'offline') {
        sitesFiltrados = sitesFiltrados.filter(site => site.status === 'offline');
      }

      sitesFiltrados.forEach((siteFiltrado) => {
        const siteItem = document.createElement("div");
        siteItem.className = "site-item";

        const indexOriginal = sites.findIndex(s => s.id === siteFiltrado.id);

        const nomeLinha = document.createElement("div");
        nomeLinha.innerHTML = `<strong title="${siteFiltrado.link}">${siteFiltrado.nome}</strong>`;

        const statusLinha = document.createElement("div");
        statusLinha.className = "status-indicator";
        statusLinha.innerHTML = `
        <span>${siteFiltrado.status.charAt(0).toUpperCase() + siteFiltrado.status.slice(1)}</span>
        <div class="dot ${siteFiltrado.status}"></div>
      `;

        const dadosLinha = document.createElement("div");
        dadosLinha.className = "credenciais";
        dadosLinha.style.display = "none";
        dadosLinha.innerHTML = `
        Login: ${siteFiltrado.login || "---"}<br>
        Senha: ${siteFiltrado.senha || "---"}<br>
        Contato: ${siteFiltrado.contato || "---"}
      `;

        const botoes = document.createElement("div");
        botoes.className = "action-buttons";

        const toggleBtn = document.createElement("button");
        toggleBtn.textContent = "Exibir";
        toggleBtn.className = "toggle-button";
        toggleBtn.addEventListener("click", () => {
          const ativo = dadosLinha.style.display === "block";
          dadosLinha.style.display = ativo ? "none" : "block";
          toggleBtn.textContent = ativo ? "Exibir" : "Ocultar";
        });

        const editBtn = document.createElement("button");
        editBtn.textContent = "Editar";
        editBtn.className = "edit-button";
        editBtn.addEventListener("click", () => abrirModalEdicao(indexOriginal));

        const deleteBtn = document.createElement("button");
        deleteBtn.textContent = "Excluir";
        deleteBtn.className = "delete-button";
        deleteBtn.addEventListener("click", async () => {
          if (confirm("Tem certeza que deseja excluir este site?")) {
            await removerSiteFirebase(siteFiltrado.id);
          }
        });

        const openBtn = document.createElement("button");
        openBtn.textContent = "Abrir";
        openBtn.className = "open-button";
        openBtn.addEventListener("click", () => abrirSiteComLogin(siteFiltrado));

        botoes.appendChild(toggleBtn);
        botoes.appendChild(editBtn);
        botoes.appendChild(deleteBtn);
        botoes.appendChild(openBtn);

        siteItem.appendChild(nomeLinha);
        siteItem.appendChild(statusLinha);
        siteItem.appendChild(dadosLinha);
        siteItem.appendChild(botoes);

        siteList.appendChild(siteItem);
      });

      atualizarContadores();
    }

    function atualizarContadores() {
      const online = sites.filter(s => s.status === "online").length;
      const offline = sites.filter(s => s.status === "offline").length;
      document.getElementById("onlineCount").textContent = online;
      document.getElementById("offlineCount").textContent = offline;
      document.getElementById("onlineExportCount").textContent = `(${online})`;
      document.getElementById("offlineExportCount").textContent = `(${offline})`;
    }

    async function atualizarEstagioFirebase(estagioAtual) {
      await setDoc(doc(db, "painel", "estagio_atual"), { valor: estagioAtual });
    }

    async function atualizarCalorFirebase(calorAtual) {
      await setDoc(doc(db, "painel", "calor_atual"), { valor: calorAtual });
    }

    async function buscarEstagioInicial() {
      console.log("Rodando buscarEstagioInicial...");
      
      // Primeiro tenta buscar da API externa
      const estagioAPI = await buscarEstagioAPI();
      
      if (estagioAPI) {
        // Se conseguiu da API, usa esse valor
        estagioAtual = estagioAPI;
        estagioImgBanner.src = `${pastaEstagios}/estagio${estagioAtual}${extensao}`;
        menuEstagios.querySelectorAll('.estagio-item').forEach((el, i) => {
          el.classList.toggle('selected', i + 1 === estagioAtual);
        });
        // Atualiza tamb√©m o Firebase para manter sincronizado
        await atualizarEstagioFirebase(estagioAtual);
        console.log("Est√°gio atualizado da API:", estagioAtual);
      } else {
        // Fallback: busca do Firebase se a API falhar
        const docSnap = await getDoc(doc(db, "painel", "estagio_atual"));
        if (docSnap.exists() && docSnap.data().valor) {
          estagioAtual = docSnap.data().valor;
          estagioImgBanner.src = `${pastaEstagios}/estagio${estagioAtual}${extensao}`;
          menuEstagios.querySelectorAll('.estagio-item').forEach((el, i) => {
            el.classList.toggle('selected', i + 1 === estagioAtual);
          });
          console.log("Est√°gio inicial do Firestore (fallback):", estagioAtual);
        }
      }
    }
    
    // Fun√ß√£o para buscar est√°gio da API externa
    async function buscarEstagioAPI() {
      try {
        console.log("Buscando est√°gio da API externa...");
        const response = await fetch(API_ESTAGIO_URL, {
          method: 'GET',
          mode: 'cors',
          cache: 'no-cache'
        });
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.text();
        
        // Tenta extrair o n√∫mero do est√°gio (funciona se retorna "1", "2", etc ou JSON {"estagio": 1})
        let estagio;
        
        // Tenta parse como JSON primeiro
        try {
          const json = JSON.parse(data);
          estagio = json.estagio || json.valor || json.stage || json.nivel || parseInt(data);
        } catch {
          // Se n√£o √© JSON, tenta pegar o n√∫mero direto
          estagio = parseInt(data.trim());
        }
        
        // Valida se √© um n√∫mero v√°lido entre 1 e 5
        if (estagio && estagio >= 1 && estagio <= 5) {
          console.log("‚úÖ Est√°gio obtido da API:", estagio);
          return estagio;
        } else {
          console.warn("‚ö†Ô∏è Valor de est√°gio inv√°lido da API:", data);
          return null;
        }
        
      } catch (error) {
        console.error("‚ùå Erro ao buscar est√°gio da API:", error);
        return null;
      }
    }
    
    // Fun√ß√£o para sincronizar com a API periodicamente
    async function sincronizarEstagioComAPI() {
      const novoEstagio = await buscarEstagioAPI();
      
      if (novoEstagio && novoEstagio !== estagioAtual) {
        console.log(`üîÑ Est√°gio mudou de ${estagioAtual} para ${novoEstagio}`);
        estagioAtual = novoEstagio;
        estagioImgBanner.src = `${pastaEstagios}/estagio${estagioAtual}${extensao}`;
        menuEstagios.querySelectorAll('.estagio-item').forEach((el, i) => {
          el.classList.toggle('selected', i + 1 === estagioAtual);
        });
        // Atualiza o Firebase tamb√©m
        await atualizarEstagioFirebase(estagioAtual);
      }
    }

    async function buscarCalorInicial() {
      console.log("Rodando buscarCalorInicial...");
      const docSnap = await getDoc(doc(db, "painel", "calor_atual"));
      if (docSnap.exists() && docSnap.data().valor) {
        calorAtual = docSnap.data().valor;
        calorImgBanner.src = `${pastaCalor}/calor${calorAtual}${extCalor}`;
        menuCalor.querySelectorAll('.calor-item').forEach((el, i) => {
          el.classList.toggle('selected', i + 1 === calorAtual);
        });
        console.log("Calor inicial do Firestore:", calorAtual);
      }
    }

    /*   Revalida o status de todas as c√¢meras (Infra Remota). */
    async function recarregarTodosAcessosRemotos() {
      if (acessosRemotos.length === 0) return;
      await Promise.all(
        acessosRemotos.map(ac => testarCameraIndividual(ac.ip, ac.id))
      );
      await carregarAcessosRemotos();
    }

    async function carregarSitesFirebase() {
      sites = [];
      const querySnapshot = await getDocs(sitesCollection);
      querySnapshot.forEach((docSnap) => {
        sites.push({ id: docSnap.id, ...docSnap.data() });
      });
      renderizarSites();
    }

    async function adicionarSiteFirebase(site) {
      try {
        await addDoc(sitesCollection, site);
      } catch (e) {
        alert("Erro ao salvar site: " + e.message);
      }
    }

    async function atualizarSiteFirebase(id, dadosAtualizados) {
      const siteDoc = doc(db, "sites", id);
      await updateDoc(siteDoc, dadosAtualizados);
      await carregarSitesFirebase();
    }

    async function removerSiteFirebase(id) {
      const siteDoc = doc(db, "sites", id);
      await deleteDoc(siteDoc);
      await carregarSitesFirebase();
    }

    async function testarSiteIndividual(nome, link, login, senha, contato, id) {
      try {
        console.log(`Testando ${nome}...`);

        const validacao1 = await fetch(link, { mode: "no-cors" }).then(() => true).catch(() => false);
        console.log("Verifica√ß√£o 1 (fetch no-cors):", validacao1);

        const validacao2 = link.startsWith("https");
        console.log("Verifica√ß√£o 2 (https):", validacao2);

        const validacao3 = await contemPalavraChave(link, "login");
        console.log("Verifica√ß√£o 3 (conte√∫do cont√©m 'login'):", validacao3);

        const online = validacao1 || validacao2 || validacao3;

        await atualizarSiteFirebase(id, { status: online ? "online" : "offline" });
        console.log(`Resultado final: ${online ? "ONLINE" : "OFFLINE"}`);
      } catch (e) {
        console.error(`Erro ao testar site ${nome}:`, e);
        await atualizarSiteFirebase(id, { status: "offline" });
      }
    }

    async function contemPalavraChave(url, palavra) {
      try {
        const resposta = await fetch(url);
        const texto = await resposta.text();
        return texto.toLowerCase().includes(palavra.toLowerCase());
      } catch {
        return false;
      }
    }

    async function testarSite() {
      const nome = document.querySelector('input[placeholder="Nome do sistema"]').value;
      const link = document.querySelector('input[placeholder="URL do sistema"]').value;
      const login = document.querySelector('input[placeholder="Usu√°rio de acesso"]').value;
      const senha = document.querySelector('input[placeholder="Senha de acesso"]').value;
      const contato = document.querySelector('input[placeholder="Contato respons√°vel"]').value;

      if (!nome || !link) {
        alert("Por favor, insira o nome e o link do sistema.");
        return;
      }

      const novoSite = {
        nome,
        link,
        status: "offline",
        login,
        senha,
        contato,
      };

      try {
        await fetch(link, { mode: "no-cors" });
        novoSite.status = "online";
      } catch (e) {
        console.error("Erro ao testar site:", e);
        novoSite.status = "offline";
      }

      await adicionarSiteFirebase(novoSite);

      document.querySelectorAll(".input-area input").forEach((input) => (input.value = ""));
      await carregarSitesFirebase();
    }

    function abrirSiteComLogin(site) {
      // Abre o site em uma nova aba
      window.open(site.link, "_blank");

      // Texto com login e senha
      const textoCopiado = `Login: ${site.login}\nSenha: ${site.senha}`;

      // Copia os dados para a √°rea de transfer√™ncia
      navigator.clipboard.writeText(textoCopiado).then(() => {
        alert("Login e senha copiados para a √°rea de transfer√™ncia! Cole no site aberto.");
      }).catch(() => {
        alert("N√£o foi poss√≠vel copiar os dados para a √°rea de transfer√™ncia.");
      });

      registrarAcessoGeralGlobal(site.id, site.nome, "sistema", "img/iconeSistema.png");
    }

    async function recarregarTodosSites() {
      if (sites.length === 0) {
        return;
      }
      // testa todos em paralelo
      const promises = sites.map(site =>
        testarSiteIndividual(site.nome, site.link, site.login, site.senha, site.contato, site.id)
      );
      await Promise.all(promises);

      // RE-RENDERIZA a lista e atualiza contadores
      renderizarSites();
    }

    function exportarTXT(dados) {
      if (dados.length === 0) {
        alert("Nenhum dado para exportar.");
        return;
      }
      // Monta texto apenas com nome e status - OK ou OFF
      let conteudo = dados
        .map(site => `${site.nome} - ${site.status === 'online' ? 'OK' : 'OFF'}`)
        .join("\n");

      const blob = new Blob([conteudo], { type: "text/plain;charset=utf-8" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "coldgend_sites.txt";
      a.click();
      URL.revokeObjectURL(url);
    }

    function exportarTodosTXT() {
      exportarTXT(sites);
    }

    function exportarPorStatusTXT(status) {
      const filtrados = sites.filter((site) => site.status === status);
      if (filtrados.length === 0) {
        alert(`Nenhum site com status "${status}" para exportar.`);
        return;
      }
      exportarTXT(filtrados);
    }

    function abrirModalEdicao(index) {
      editIndex = index;
      const site = sites[index];
      document.getElementById("editNome").value = site.nome;
      document.getElementById("editLogin").value = site.login;
      document.getElementById("editSenha").value = site.senha;
      document.getElementById("editContato").value = site.contato;
      document.getElementById("editModal").style.display = "flex";
    }

    function fecharModal() {
      document.getElementById("editModal").style.display = "none";
    }

    async function salvarEdicao() {
      const nome = document.getElementById("editNome").value;
      const login = document.getElementById("editLogin").value;
      const senha = document.getElementById("editSenha").value;
      const contato = document.getElementById("editContato").value;

      if (editIndex !== null) {
        const site = sites[editIndex];
        await atualizarSiteFirebase(site.id, { nome, login, senha, contato });
        fecharModal();
      }
    }

    document.querySelector(".test-button").addEventListener("click", testarSite);
    document.querySelector(".clear-button").addEventListener("click", async () => {
      if (confirm("Tem certeza que deseja apagar todos os sites?")) {
        const querySnapshot = await getDocs(sitesCollection);
        const deletePromises = [];
        querySnapshot.forEach((docSnap) => {
          deletePromises.push(deleteDoc(doc(db, "sites", docSnap.id)));
        });
        await Promise.all(deletePromises);
        await carregarSitesFirebase();
      }
    });
    document.querySelector(".export-button").addEventListener("click", () => exportarTodosTXT());
    document.getElementById("reloadAllBtn").addEventListener("click", recarregarTodosSites);
    document.getElementById("exportOnlineBtn").addEventListener("click", () => exportarPorStatusTXT("online"));
    document.getElementById("exportOfflineBtn").addEventListener("click", () => exportarPorStatusTXT("offline"));
    document.getElementById("searchInput").addEventListener("input", (e) => {
      filtroAtual = e.target.value;
      renderizarSites();
    });
    document.getElementById("btnSalvarEdicao").addEventListener("click", salvarEdicao);
    document.getElementById("btnCancelarEdicao").addEventListener("click", fecharModal);
    document.getElementById("editModal").addEventListener("click", (e) => {
      if (e.target === document.getElementById("editModal")) fecharModal();
    });
    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape") fecharModal();
    });
    document.getElementById("filterAllBtn").addEventListener("click", () => {
      filtroStatus = "todos";
      setActiveButton("filterAllBtn");
      renderizarSites();
    });
    document.getElementById("filterOnlineBtn").addEventListener("click", () => {
      filtroStatus = "online";
      setActiveButton("filterOnlineBtn");
      renderizarSites();
    });
    document.getElementById("filterOfflineBtn").addEventListener("click", () => {
      filtroStatus = "offline";
      setActiveButton("filterOfflineBtn");
      renderizarSites();
    });

    // Filtro de texto
    document.addEventListener("DOMContentLoaded", () => {
      document.getElementById("searchRemoteInput")
        .addEventListener("input", e => {
          filtroRemoto = e.target.value;
          renderizarAcessosRemotos();
        });

      // Tipo: Todos
      document.getElementById("typeAll")
        .addEventListener("click", () => {
          filtroTipo = "todos";
          setActiveTypeButton("typeAll");
          renderizarAcessosRemotos();
        });

      // Tipo: CFTV
      document.getElementById("typeCFTV")
        .addEventListener("click", () => {
          filtroTipo = "CFTV";
          setActiveTypeButton("typeCFTV");
          renderizarAcessosRemotos();
        });

      // Tipo: Controle de Acesso
      document.getElementById("typeControle")
        .addEventListener("click", () => {
          filtroTipo = "Controle de Acesso";
          setActiveTypeButton("typeControle");
          renderizarAcessosRemotos();
        });
    });

    // Fun√ß√£o de helper para marcar o bot√£o ativo
    function setActiveTypeButton(activeId) {
      document.querySelectorAll(".type-filter").forEach(btn => {
        btn.classList.toggle("active", btn.id === activeId);
      });
    }

    document.querySelectorAll('.panel-item').forEach(item => {
      item.addEventListener('click', function () {
        const id = item.href || item.dataset.id || item.querySelector('img')?.alt || '';
        const nome = item.querySelector('img')?.alt || 'Acesso R√°pido';
        const tipo = "painel";
        const img = item.querySelector('img')?.getAttribute('src') || "";
        registrarAcessoGeralGlobal(id, nome, tipo, img);
        // O acesso ser√° salvo no ranking com a miniatura
      });
    });

    function setActiveButton(id) {
      document.querySelectorAll(".filter-status-button").forEach(btn => {
        btn.classList.remove("active");
      });
      document.getElementById(id).classList.add("active");
    }

    async function iniciar() {
      await carregarSitesFirebase();
      await carregarAnyDesk();
      await carregarAcessosRemotos(); // agora ele carrega os acessos tamb√©m!
      await recarregarTodosSites();
    }

    // Filtra equipamento remoto conforme o usu√°rio digita
    document.addEventListener("DOMContentLoaded", () => {
      const inputRemoto = document.getElementById("searchRemoteInput");
      inputRemoto.addEventListener("input", e => {
        filtroRemoto = e.target.value.trim().toLowerCase();
        renderizarAcessosRemotos();
      });
    });

    window.addEventListener('load', async () => {
      document.getElementById('editModal').style.display = 'none';
      iniciar();

      // Configura os bot√µes do AnyDesk
      const btnCadastrar = document.getElementById("btnCadastrarAny");
      const btnLimpar = document.getElementById("btnLimparAny");

      await recarregarTodosSites();
      // 4) Agenda revalida√ß√£o de Sites a cada 2 minutos
      setInterval(recarregarTodosSites, 120000);

      // 5) Verifica imediatamente o status de todos os Equipamentos Remotos
      await recarregarTodosAcessosRemotos();
      // 6) Agenda revalida√ß√£o de Infra Remota a cada 2 minutos
      setInterval(recarregarTodosAcessosRemotos, 120000);
      
      // 7) Sincroniza o est√°gio com a API externa a cada 5 segundos
      console.log("üîÑ Iniciando sincroniza√ß√£o autom√°tica com API de est√°gio...");
      setInterval(sincronizarEstagioComAPI, 5000);

      if (btnCadastrar && btnLimpar) {
        btnCadastrar.addEventListener("click", cadastrarAnyDesk);
        btnLimpar.addEventListener("click", limparAnyDesk);
      }
    });

    const images = [
      "nils-calor/1.jpg",
      "nils-calor/2.jpg",
      "nils-calor/3.jpg",
      "nils-calor/4.jpg",
      "nils-calor/5.jpg",
    ];

    const imgElement = document.getElementById("clicavelImage");
    let currentIndex = 0;

    imgElement.addEventListener("click", () => {
      currentIndex = (currentIndex + 1) % images.length;
      imgElement.src = images[currentIndex];
    });

    /* Parte onde ficara O script do anydek */
    let acessosAnyDesk = [];

    async function cadastrarAnyDesk() {
      const nome = document.getElementById("nomeAny").value.trim();
      const ip = document.getElementById("ipAny").value.trim();
      const login = document.getElementById("loginAny").value.trim();
      const senha = document.getElementById("senhaAny").value.trim();

      if (!nome || !ip) {
        alert("Preencha pelo menos o nome e o IP.");
        return;
      }

      const novoAcesso = { nome, ip, login, senha };

      try {
        await addDoc(anydeskCollection, novoAcesso);
        alert("Acesso AnyDesk salvo com sucesso!");
        limparAnyDesk();
        await carregarAnyDesk(); // atualiza a lista ap√≥s salvar
      } catch (e) {
        alert("Erro ao salvar no Firebase: " + e.message);
      }
    }

    function limparAnyDesk() {
      document.getElementById("nomeAny").value = "";
      document.getElementById("ipAny").value = "";
      document.getElementById("loginAny").value = "";
      document.getElementById("senhaAny").value = "";
    }

    // Lidar com eventos dos bot√µes AnyDesk
    document.getElementById("btnCadastrarAny").addEventListener("click", cadastrarAnyDesk);
    document.getElementById("btnLimparAny").addEventListener("click", limparAnyDesk);

    function renderizarAnyDesk() {
      const lista = document.getElementById("anydesk-list");
      if (!lista) return;
      lista.innerHTML = "";

      const termo = (filtroAnyDesk || "").toLowerCase().trim();
      const filtrados = acessosAnyDesk.filter(({ nome, ip }) =>
        `${nome} ${ip}`.toLowerCase().includes(termo)
      );

      if (filtrados.length === 0) {
        const msg = document.createElement("div");
        msg.textContent = "Nenhuma conex√£o encontrada.";
        msg.style.padding = "15px";
        lista.appendChild(msg);
        return;
      }

      filtrados.forEach(item => {
        const div = document.createElement("div");
        div.className = "site-item";

        const header = document.createElement("div");
        header.innerHTML = `<strong>${item.nome}</strong><br>IP/ID: ${item.ip}`;
        div.appendChild(header);

        const dados = document.createElement("div");
        dados.className = "credenciais";
        dados.style.display = "none";
        dados.innerHTML = `
      <strong>MCOR:</strong> ${item.login || "---"}<br>
      <strong>Senha:</strong> ${item.senha || "---"}
    `;
        div.appendChild(dados);

        const botoes = document.createElement("div");
        botoes.className = "action-buttons";

        const exibirBtn = document.createElement("button");
        exibirBtn.className = "toggle-button";
        exibirBtn.textContent = "Exibir Detalhes";
        exibirBtn.addEventListener("click", () => {
          const aberto = dados.style.display === "block";
          dados.style.display = aberto ? "none" : "block";
          exibirBtn.textContent = aberto ? "Exibir Detalhes" : "Ocultar Detalhes";
        });

        const abrirBtn = document.createElement("button");
        abrirBtn.className = "open-button";
        abrirBtn.textContent = "Abrir";
        abrirBtn.addEventListener("click", () => {
          window.location.href = `anydesk:${item.ip}`;
          registrarAcessoGeralGlobal(item.id, item.nome, "anydesk", "img/iconeAny.png");
        });

        const editBtn = document.createElement("button");
        editBtn.className = "edit-button";
        editBtn.textContent = "Editar";
        editBtn.addEventListener("click", () => abrirModalEditAny(item.id));

        const copiarBtn = document.createElement("button");
        copiarBtn.className = "open-button";
        copiarBtn.textContent = "Copiar";
        copiarBtn.addEventListener("click", async () => {
          const texto = `Usu√°rio: ${item.login || "---"}\nSenha: ${item.senha || "---"}`;
          try {
            await navigator.clipboard.writeText(texto);
            alert("Credenciais copiadas!");
          } catch {
            alert("N√£o foi poss√≠vel copiar.");
          }
        });

        const deleteBtn = document.createElement("button");
        deleteBtn.className = "delete-button";
        deleteBtn.textContent = "Excluir";
        deleteBtn.addEventListener("click", () => removerAnyDesk(item.id));

        botoes.append(exibirBtn, abrirBtn, editBtn, copiarBtn, deleteBtn);
        div.appendChild(botoes);
        lista.appendChild(div);
      });
    }

    // Fora da fun√ß√£o! Assim:
    async function removerAnyDesk(id) {

      if (!id) return;

      const confirmacao = confirm("Tem certeza que deseja excluir este acesso?");
      if (!confirmacao) return;

      try {
        await deleteDoc(doc(db, "anydesk", id));
        await carregarAnyDesk();
      } catch (e) {
        alert("Erro ao remover: " + e.message);
      }
    }

    // √¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨ AnyDesk: Editar Conex√£o √¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨√¢‚Äù‚Ç¨
    // Abre o modal preenchendo com os dados atuais
    function abrirModalEditAny(id) {
      const item = acessosAnyDesk.find(i => i.id === id);
      if (!item) return;
      document.getElementById("editAnyNome").value = item.nome;
      document.getElementById("editAnyIP").value = item.ip;
      document.getElementById("editAnyUser").value = item.login;
      document.getElementById("editAnySenha").value = item.senha;
      document.getElementById("editAnyModal").style.display = "flex";
      window.editAnyId = id; // Salva globalmente para o salvar usar depois
    }

    // Fecha o modal sem salvar
    function fecharModalEditAny() {
      document.getElementById("editAnyModal").style.display = "none";
    }

    // Salva as altera√ß√µes no Firestore e recarrega a lista
    async function salvarEdicaoAny() {
      const nome = document.getElementById("editAnyNome").value.trim();
      const ip = document.getElementById("editAnyIP").value.trim();
      const login = document.getElementById("editAnyUser").value.trim();
      const senha = document.getElementById("editAnySenha").value.trim();
      const id = window.editAnyId; // Usa o ID salvo

      if (!id) return;

      await updateDoc(doc(db, "anydesk", id), { nome, ip, login, senha });
      fecharModalEditAny();
      await carregarAnyDesk();
    }

    async function carregarAnyDesk() {
      acessosAnyDesk = [];
      const querySnapshot = await getDocs(anydeskCollection);
      querySnapshot.forEach((docSnap) => {
        const data = docSnap.data();
        acessosAnyDesk.push({ id: docSnap.id, ...data }); // üîç aqui est√° o ID
      });
      renderizarAnyDesk();
    }

    /* -----------------------------√Årea acesso Remoto--------------------------- */
    async function cadastrarAcessoRemoto() {
      const setor = document.getElementById("inputSetor").value.trim();
      const andar = document.getElementById("inputAndar").value.trim();
      const tipo = document.getElementById("inputTipo").value.trim();
      const camera = document.getElementById("inputCamera").value.trim();
      const sala = document.getElementById("inputSala").value.trim();
      const ip = document.getElementById("inputIP").value.trim();

      if (!setor || !andar || !tipo || !ip) {
        alert("Preencha os campos obrigat√≥rios: Setor, Andar, Tipo e IP.");
        return;
      }

      const novoAcesso = { setor, andar, tipo, camera, sala, ip };

      try {
        await addDoc(acessosRemotosCollection, novoAcesso);
        alert("Acesso remoto salvo com sucesso!");
        limparAcessoRemoto();
        await carregarAcessosRemotos();
      } catch (e) {
        alert("Erro ao salvar no Firebase: " + e.message);
        console.error("Erro:", e);
      }
    }

    /* ----------------Ponto importante-------------- */
    function limparAcessoRemoto() {
      document.getElementById("inputSetor").value = "";
      document.getElementById("inputAndar").value = "";
      document.getElementById("inputTipo").value = "";
      document.getElementById("inputCamera").value = "";
      document.getElementById("inputSala").value = "";
      document.getElementById("inputIP").value = "";
    }

    async function carregarAcessosRemotos() {
      acessosRemotos = []; // √¢‚Ä†¬ê limpa tudo antes
      const querySnapshot = await getDocs(acessosRemotosCollection);
      querySnapshot.forEach(docSnap => {
        acessosRemotos.push({ id: docSnap.id, ...docSnap.data() });
      });
      updateContadoresRemotos();
      renderizarAcessosRemotos();
    }

    /** * Exclui um acesso remoto do Firestore e recarrega a lista.*/
    async function removerAcessoRemoto(id) {
      if (!confirm("Tem certeza que deseja excluir este equipamento?")) return;
      try {
        await deleteDoc(doc(db, "acessos_remotos", id));
        console.log("√¢≈ì‚Ä¶ Equipamento remoto exclu√≠do:", id);
      } catch (err) {
        console.error("√¢¬ù≈í Erro ao excluir equipamento:", err);
        alert("Erro ao excluir equipamento: " + err.message);
        return;
      }
      // Recarrega a lista ap√≥s exclus√£o
      carregarAcessosRemotos();
    }

    // --- Renderizar acessos ---
    // Renderiza a lista inteira
    function renderizarAcessosRemotos() {
      const lista = document.getElementById("acessos-remotos-list");
      lista.innerHTML = "";

      // 1) Ordena por setor
      const ordenados = [...acessosRemotos].sort(
        (a, b) => Number(a.setor) - Number(b.setor)
      );

      // 2) Aplica filtros de texto e de tipo em sequ√™ncia
      const finalList = ordenados
        .filter(acesso => {
          const combinado = `
        ${acesso.setor}
        ${acesso.andar}
        ${acesso.tipo}
        ${acesso.camera || ""}
        ${acesso.sala || ""}
        ${acesso.ip || ""}
      `.toLowerCase();
          return combinado.includes(filtroRemoto.trim().toLowerCase());
        })
        .filter(acesso => {
          // usa filtroTipoRemoto (declared no topo do seu script)
          return filtroTipoRemoto === "todos"
            || acesso.tipo === filtroTipoRemoto;
        });

      // 3) Se n√£o houver resultados, exibe mensagem
      if (finalList.length === 0) {
        const msg = document.createElement("div");
        msg.textContent = "Nenhum equipamento encontrado.";
        msg.style.padding = "15px";
        return lista.appendChild(msg);
      }

      // 4) Renderiza cada item filtrado
      finalList.forEach(acesso => {
        const item = document.createElement("div");
        item.className = "registro-item";

        // ‚Äî‚Äî Info ‚Äî‚Äî 
        const info = document.createElement("div");
        info.className = "info-topo";
        info.innerHTML = `
      <strong>Setor:</strong> ${acesso.setor}<br>
      <strong>Andar:</strong> ${acesso.andar}<br>
      <strong>Tipo:</strong> ${acesso.tipo}<br>
      <strong>C√¢mera:</strong> ${acesso.camera || "N/A"}<br>
      <strong>Sala T√©cnica:</strong> ${acesso.sala || "N/A"}<br>
      <strong>IP:</strong> ${acesso.ip}
    `;

        // ‚Äî‚Äî Bot√µes ‚Äî‚Äî 
        const botoes = document.createElement("div");
        botoes.className = "registro-botoes";

        // Verificar
        const btnVerificar = document.createElement("button");
        btnVerificar.className = "verificar-btn";
        btnVerificar.textContent = "Verificar";
        btnVerificar.addEventListener("click", () => testarTodasPortas(acesso.ip, acesso.id));

        botoes.appendChild(btnVerificar);

        // Detalhes
        const btnDetalhes = document.createElement("button");
        btnDetalhes.className = "detalhes-btn";
        btnDetalhes.textContent = "üîç Detalhes";
        btnDetalhes.addEventListener("click", () => {
          const textoDetalhes =
            `Setor: ${acesso.setor}\n` +
            `Andar: ${acesso.andar}\n` +
            `Tipo: ${acesso.tipo}\n` +
            `C√¢mera: ${acesso.camera || "N/A"}\n` +
            `Sala T√©cnica: ${acesso.sala || "N/A"}\n` +
            `IP: ${acesso.ip}`;
          abrirModalDetalhes(textoDetalhes);
        });
        botoes.appendChild(btnDetalhes);

        // Excluir (com data-id e debug)
        const btnExcluir = document.createElement("button");
        btnExcluir.className = "excluir-btn";
        btnExcluir.textContent = "√¢¬ù≈í Excluir";
        btnExcluir.dataset.id = acesso.id;
        btnExcluir.addEventListener("click", e => {
          const idParaExcluir = e.currentTarget.dataset.id;
          console.log("üî¥ Clique em Excluir, id =", idParaExcluir);
          removerAcessoRemoto(idParaExcluir);
        });
        botoes.appendChild(btnExcluir);

        item.append(info, botoes);
        lista.appendChild(item);
      });

    }

    /*Ponte de verifica*/
    async function testarCameraIndividual(ip, id) {
      try {
        await fetch(`http://${ip}`, { mode: "no-cors" });
        await updateDoc(doc(db, "acessos_remotos", id), { status: "ativa" });
      } catch {
        await updateDoc(doc(db, "acessos_remotos", id), { status: "inativa" });
      }
    }

    async function atualizarStatusCamera(id, status) {
      const docRef = doc(db, "acessos_remotos", id);
      await updateDoc(docRef, { status });
      await carregarAcessosRemotos();
    }

    async function testarTodasPortas(ip, id) {
      // Portas conhecidas para DVR/NVR/CFTV
      const portas = [80, 554, 37777, 8080, 8000, 443];

      // Vai tentar todas, em paralelo (promises)
      let online = false;
      for (const porta of portas) {
        try {
          await fetch(`http://${ip}:${porta}`, { mode: "no-cors" });
          online = true;
          break; // Parou na primeira que responder
        } catch (e) {
          // continua tentando
        }
      }

      // Atualiza status no banco e na interface
      await updateDoc(doc(db, "acessos_remotos", id), { status: online ? "ativa" : "inativa" });
      return online;
    }

    // Exportar acessos remotos para TXT
    function exportarAcessosRemotosTXT() {
      if (acessosRemotos.length === 0) {
        alert("Nenhum acesso remoto para exportar.");
        return;
      }

      let conteudo = acessosRemotos.map(acesso =>
        `Setor: ${acesso.setor} | Andar: ${acesso.andar} | Tipo: ${acesso.tipo} | C√¢mera: ${acesso.camera || "---"} | Sala T√©cnica: ${acesso.sala || "---"} | IP: ${acesso.ip}`
      ).join("\n");

      const blob = new Blob([conteudo], { type: "text/plain;charset=utf-8" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "acessos_remotos.txt";
      a.click();
      URL.revokeObjectURL(url);
    }

    // Modal de Detalhes
    function abrirModalDetalhes(texto) {
      document.getElementById("detalhesTexto").innerText = texto;
      document.getElementById("modalDetalhesEquipamento").style.display = "flex";
    }

    function fecharModalDetalhes() {
      document.getElementById("modalDetalhesEquipamento").style.display = "none";
    }

    if (!btnSeletores) {
      console.error("N√£o encontrei #btnAbrirModalSeletores");
    } else {
      // 2) sempre que clicarem, simulam o clique nos banners
      btnSeletores.addEventListener("click", e => {
        e.stopPropagation();
        if (bannerEstagio) bannerEstagio.click();
        if (bannerCalor) bannerCalor.click();
      });
    }

    document.getElementById("btnFecharDetalhes").addEventListener("click", fecharModalDetalhes);
    document.getElementById("btnCopiarDetalhes").addEventListener("click", () => {
      const texto = document.getElementById("detalhesTexto").innerText;
      navigator.clipboard.writeText(texto).then(() => {
        alert("Dados copiados para a √°rea de transfer√™ncia!");
      });
    });


    window.addEventListener("DOMContentLoaded", () => {

      /* Par√¢metro que chama o renderizar TopGeral */
      iniciarRankingTempoReal();

      // Se√ß√µes principais
      document.getElementById("btnSites").addEventListener("click", () => {
        document.getElementById("mainSites").style.display = "flex";
        document.getElementById("mainAnyDesk").style.display = "none";
        document.getElementById("mainAcessosRemotos").style.display = "none";
      });

      // Quando clicar no bot√£o, dispara o mesmo evento de abrir menu do banner
      // Mostra bot√£o apenas no mobile
      const btnSeletores = document.getElementById("btnAbrirModalSeletores");
      if (window.innerWidth <= 600 && btnSeletores) {
        btnSeletores.style.display = "block";
        btnSeletores.onclick = function () {
          let abriu = false;
          const bannerEstagio = document.getElementById("estagioBanner");
          const bannerCalor = document.getElementById("calorBanner");
          if (bannerEstagio) {
            bannerEstagio.click();
            abriu = true;
          }
          if (bannerCalor) {
            bannerCalor.click();
            abriu = true;
          }
          if (!abriu) alert('Nenhum seletor dispon√≠vel!');
        };
      }

      // Abrir menu ao clicar no banner
      estagioBanner.addEventListener('click', function (e) {
        menuEstagios.style.display = menuEstagios.style.display === 'flex' ? 'none' : 'flex'; e.stopPropagation();
      });

      // Fecha menu ao clicar fora
      document.body.addEventListener('click', function () {
        menuEstagios.style.display = 'none';
      });

      // Previne fechamento do menu ao clicar dentro
      menuEstagios.addEventListener('click', function (e) {
        e.stopPropagation();
      });

      // Abrir menu ao clicar no banner
      calorBanner.addEventListener('click', function (e) {
        menuCalor.style.display = menuCalor.style.display === 'flex' ? 'none' : 'flex'; e.stopPropagation();
      });

      document.body.addEventListener('click', function () {
        menuCalor.style.display = 'none';
      });

      menuCalor.addEventListener('click', function (e) {
        e.stopPropagation();
      });

      // Bot√£o para abrir o visualizador em tela cheia (est√°gio)
      // Est√°gio
      btnAbrirVisualizador.addEventListener('click', function () {
        console.log('Bot√£o Est√°gio clicado!'); window.open('visualizar.html?tipo=estagio', '_blank');
      });

      // Bot√£o para abrir o visualizador em tela cheia (calor)
      // Calor
      btnAbrirVisualizadorCalor.addEventListener('click', function () {
        console.log('Bot√£o Calor clicado!'); window.open('visualizar.html?tipo=calor', '_blank');
      });

      const btnSel = document.getElementById("btnAbrirModalSeletores");
      const btnVarLegal = document.getElementById('btn-var-legal');
      const overlay = document.getElementById('modal-overlay');
      const modalCloseBtn = document.getElementById('modal-close');

      // Abre modal
      btnVarLegal.addEventListener('click', () => {
        overlay.classList.remove('hidden');
      });

      // Fecha modal ao clicar no √ó¬ù
      modalCloseBtn.addEventListener('click', () => {
        overlay.classList.add('hidden');
      });

      // Fecha modal ao clicar fora do conte√∫do
      overlay.addEventListener('click', e => {
        if (e.target === overlay) {
          overlay.classList.add('hidden');
        }
      });

      btnSel.addEventListener("click", e => {
        // alterna a classe open em ambos
        menuEstagios.classList.toggle("open");
        menuCalor.classList.toggle("open");
        e.stopPropagation();
      });

      // fechar menus ao clicar fora
      document.body.addEventListener("click", () => {
        menuEstagios.classList.remove("open");
        menuCalor.classList.remove("open");
      });

      document.getElementById("btnAnyDesk").addEventListener("click", () => {
        document.getElementById("mainSites").style.display = "none";
        document.getElementById("mainAnyDesk").style.display = "flex";
        document.getElementById("mainAcessosRemotos").style.display = "none";
      });

      document.getElementById("btnAcessosRemotos").addEventListener("click", () => {
        document.getElementById("mainSites").style.display = "none";
        document.getElementById("mainAnyDesk").style.display = "none";
        document.getElementById("mainAcessosRemotos").style.display = "flex";
      });

      // AnyDesk
      document.getElementById("btnCadastrarAny")?.addEventListener("click", cadastrarAnyDesk);
      document.getElementById("btnLimparAny")?.addEventListener("click", limparAnyDesk);
      document.getElementById("btnSalvarAnyEdit")?.addEventListener("click", salvarEdicaoAny);
      document.getElementById("btnCancelarAnyEdit")?.addEventListener("click", fecharModalEditAny);

      // Infraestrutura Remota
      document.getElementById("btnCadastrarAcesso").addEventListener("click", cadastrarAcessoRemoto);
      document.getElementById("btnLimparAcesso").addEventListener("click", limparAcessoRemoto);
      document.getElementById("btnVerificarRemotos")
        .addEventListener("click", async () => {
          const btn = document.getElementById("btnVerificarRemotos");
          btn.disabled = true;
          btn.textContent = "Verificando...";

          // dispara TODOS os testes em paralelo
          await Promise.all(
            acessosRemotos.map(a => testarCameraIndividual(a.ip, a.id))
          );

          // s√≥ depois de todos, recarrega e atualiza a tela
          await carregarAcessosRemotos();

          btn.disabled = false;
          btn.textContent = "Verificar Todas";
        });

      registrarAcessoGeralGlobal(id, nome, tipo, img);
      // Busca por texto na lista de remotos
      document.getElementById("searchRemoteInput")
        .addEventListener("input", e => {
          filtroRemoto = e.target.value;
          renderizarAcessosRemotos();
        });

      // Bot√µes de filtro por tipo na lista de remotos
      ["filterRemoteAll", "filterRemoteCFTV", "filterRemoteContAcesso"]
        .forEach(btnId => {
          document.getElementById(btnId)
            .addEventListener("click", () => {
              // define filtroTipoRemoto
              if (btnId === "filterRemoteAll") filtroTipoRemoto = "todos";
              else if (btnId === "filterRemoteCFTV") filtroTipoRemoto = "CFTV";
              else if (btnId === "filterRemoteContAcesso") filtroTipoRemoto = "Cont.Acesso";

              // ajusta classe .active
              document.querySelectorAll(".filter-status-button")
                .forEach(b => b.classList.remove("active"));
              document.getElementById(btnId).classList.add("active");

              // re-renderiza
              renderizarAcessosRemotos();
            });
        });

      document.getElementById("searchAnyDeskInput")
        .addEventListener("input", e => {
          filtroAnyDesk = e.target.value.trim().toLowerCase();
          renderizarAnyDesk();
        });
    });
  </script>
</body>

</html>